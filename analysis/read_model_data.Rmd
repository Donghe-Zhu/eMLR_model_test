---
title: "Read and plot model data"
author: "Donghe Zhu and Dr Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---


```{r global_options, include = FALSE}
# Some basic settings to improve the html output
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```


# Required Packages

```{r Load_package}
library(tidyverse) # the tidverse combines several packages

library(ncdf4)
library(stars)
library(tidync)
library(tidyselect)
library(geosphere)
library(PCICt)
```


```{r ggplot_theme, include = FALSE}
# ggplot theme for all plots
theme_set(theme_bw())
```

# Read data from netcdf file

The error is in below "Read in file and extract variable DIC" chunk. I encounter problem when extracting variable DIC from the file (line 32). When I use hyper_tibble or hyper_filter to select variable DIC from 368 variables, I encounter with error "Error in hyper_array.tidync(x, ...) : no select_var variables available" or "Warning message: In hyper_filter.tidync(., select_var = "DIC"): 'select_var' not found in active grid, ignoring". 

I want to get a tibble of DIC data, with labels of real latitude, longitude, depth, month and value (if not real latitude and longitude (grid sequence number), I also need to find how to link the real ones with the grid sequence number). But now I don't know how could I obtain the DIC tibble with tidync.

Since I fail in the data extraction, I am sure that there are some errors following this one. But as long as I can read in the data, I can figure out the following code. 
```{r Read_file_and_extract_DIC}

# read one variable from file
nc_data <- read_ncdf(here::here("data",
                                "GIAF_JRA.pop.h.0354.nc"),
                     var = "DIC")

# convert to tibble
nc_data_tibble <- nc_data %>%
  as.tibble()

# filter surface data
nc_data_tibble_surface <- nc_data_tibble %>%
  filter(z_t == 500)

# filter winter data
nc_data_tibble_surface_winter <- nc_data_tibble_surface %>%
  filter(time == as.PCICt("0354-12-30", cal = "365_day"))

nc_data_tibble_surface_winter <- nc_data_tibble_surface_winter %>%
  mutate(DIC = as.numeric(DIC))

nc_data_tibble_surface_winter <- nc_data_tibble_surface_winter %>%
  filter(!is.na(DIC))



```

# Map surface DIC

```{r Map_surface_DIC}

nc_data_tibble_surface_winter %>%
  filter(DIC > 1800) %>%
  ggplot() +
  geom_point(aes(nlon, nlat, col = DIC)) +
  scale_color_viridis_c() +
  coord_quickmap(expand = 0)

```


```{r U-shape distance-depth plot, eval = FALSE}
# set parameters
parameters <- data.frame(
  lon_Atl_section = 335.5,
  lat_section_N = 60.5,
  lat_section_S = -60.5,
  lon_Pac_section = 190.5,
  lat_max = 65
)

# read in mask files
landsea_01 <- read_csv(here::here("data",
                                  "landsea_01.msk"),
                         skip = 1,
                         col_types = list(.default = "d"))
basinmask_01 <- read_csv(here::here("data",
                                    "basinmask_01.msk"),
                         skip = 1,
                         col_types = list(.default = "d"))

# select and rename basinmask
basinmask_01 <- basinmask_01 %>% 
  select(Latitude: Longitude) %>%
  rename(lat = Latitude, lon = Longitude)

# select only latitude and longitude data
section <- basinmask_01 %>%
  select(lon, lat)

# select Atlantic section
Atl_NS <- section %>%
  filter(
    lon == parameters$lon_Atl_section,
    lat <= parameters$lat_section_N,
    lat >= parameters$lat_section_S
  ) %>%
  arrange(-lat)

# select Atlantic-Southern Ocean section
Atl_SO <- section %>%
  filter(lon > parameters$lon_Atl_section,
         lat == parameters$lat_section_S) %>%
  arrange(lon)

# select Pacific-Southern Ocean section
Pac_SO <- section %>%
  filter(lon < parameters$lon_Pac_section,
         lat == parameters$lat_section_S) %>%
  arrange(lon)

# select Pacific Ocean section
Pac_SN <- section %>%
  filter(
    lon == parameters$lon_Pac_section,
    lat <= parameters$lat_section_N,
    lat >= parameters$lat_section_S
  ) %>%
  arrange(lat)

# combine to the whole U-shape route
section_global_coordinates <- bind_rows(Atl_NS,
                     Atl_SO,
                     Pac_SO,
                     Pac_SN)

#section_global_coordinates <- section_global_coordinates %>%
#  mutate(lon_180 = if_else(lon > 180, lon - 360, lon))

# calculate distance since the starting point
section_global_coordinates <- section_global_coordinates %>%
  mutate(dist_int = distGeo(cbind(lon, lat)) / 1e6) %>%   # diff
  mutate(dist = cumsum(dist_int))

# select latitude, longitude, distance labels
section_global_coordinates <- section_global_coordinates %>%
  select(lon, lat, dist) %>% 
  drop_na()

rm(Atl_NS, Atl_SO, Pac_SN, Pac_SO, section)

# to be continued

```

```{r Zonal mean DIC, eval = FALSE}
# read in basinmask and landsea file
basinmask_01 <- read_csv(here::here("data",
                                    "basinmask_01.msk"),
                         skip = 1,
                         col_types = list(.default = "d"))
basinmask_01 <- basinmask_01 %>% 
  select(Latitude:Basin_0m) %>% 
  mutate(Basin_0m = as.factor(Basin_0m)) %>% 
  rename(lat = Latitude, lon = Longitude)
landsea_01 <- read_csv(here::here("data",
                                    "landsea_01.msk"),
                         skip = 1,
                         col_types = list(.default = "d"))
landsea_01 <- landsea_01 %>% 
  rename(lat = Latitude, lon = Longitude)

# divide into Pacific, Indian and Pacific Ocean
basinmask_01 <- basinmask_01 %>% 
  filter(Basin_0m %in% c("1", "2", "3", "10", "11", "12", "56"),
         lat <= parameters$lat_max) %>% 
  mutate(basin_AIP = "none",
         basin_AIP = case_when(
           Basin_0m == "1" ~ "Atlantic",
           Basin_0m == "10" & lon >= -63 & lon < 20 ~ "Atlantic",
           Basin_0m == "11" ~ "Atlantic",
           Basin_0m == "3" ~ "Indian",
           Basin_0m == "10" & lon >= 20 & lon < 147 ~ "Indian",
           Basin_0m == "2" ~ "Pacific",
           Basin_0m == "12" ~ "Pacific",
           Basin_0m == "56" ~ "Pacific",
           Basin_0m == "10" & lon >= 147 | lon < -63 ~ "Pacific")) %>% 
  select(-Basin_0m) 
#  mutate(lon = if_else(lon < 20, lon + 360, lon))

# plot three ocean scope
ggplot() +
  geom_raster(data = landsea_01,
              aes(lon, lat), fill = "grey80") +
  geom_raster(data = basinmask_01,
              aes(lon, lat, fill = basin_AIP)) +
  scale_fill_brewer(palette = "Dark2") +
  coord_quickmap(expand = 0) +
  theme(legend.position = "top",
        legend.title = element_blank(),
        axis.title = element_blank())

# seperate Oceans with lat and lon
basin_Pacific <- basinmask_01 %>%
  filter(basin_AIP=="Pacific") 
basin_Indian<-basinmask_01 %>%
  filter(basin_AIP=="Indian") 
basin_Atlantic<-basinmask_01 %>%
  filter(basin_AIP=="Atlantic")

# read in DIC data
nc_data <- tidync(here::here("data",
                      "GIAF_JRA.pop.h.0354.nc"))
DIC <- nc_data %>%
  hyper_tibble(select_var = "DIC") %>%
  hyper_filter(depth = 500, month = 8)

# join DIC tibbles and plot basin zonal mean DIC
DIC_Pacific <- left_join(basin_Pacific, DIC) %>%
  group_by(lat) %>%
  summarise(value = mean(value, na.rm = TRUE)) %>%
  ggplot(aes(lat, value)) +
  labs(title = "Zone Mean DIC", subtitle = "Subsection: Pacific Ocean", x = "Latitude", y = expression(paste("DIC (gC m"^-2, "s"^-1, ")")))

DIC_Indian <- left_join(basin_Indian, DIC) %>%
  group_by(lat) %>%
  summarise(value = mean(value, na.rm = TRUE)) %>%
  ggplot(aes(lat, value)) +
  labs(title = "Zone Mean DIC", subtitle = "Subsection: Indian Ocean", x = "Latitude", y = expression(paste("DIC (gC m"^-2, "s"^-1, ")")))

DIC_Atlantic <- left_join(basin_Atlantic, DIC) %>%
  group_by(lat) %>%
  summarise(value = mean(value, na.rm = TRUE)) %>%
  ggplot(aes(lat, value)) +
  labs(title = "Zone Mean DIC", subtitle = "Subsection: Atlantic Ocean", x = "Latitude", y = expression(paste("DIC (gC m"^-2, "s"^-1, ")")))
```

